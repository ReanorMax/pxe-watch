<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>PXE Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" />
  <!-- Тема Dracula -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css" />
  <!-- Шрифт Fira Code -->
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  
</head>
<body>
  <header>
    <h1><i class="fa fa-server"></i> PXE Dashboard</h1>
    <div style="display:flex;gap:12px;align-items:center;">
      <div class="header-group">
        <a class="btn btn-semaphore" href="http://10.19.1.90:3000" target="_blank" rel="noopener noreferrer">
          <i class="fa fa-external-link-alt"></i> Semaphore
        </a>
        <a class="btn btn-logtail" href="{{ url_for('logtail.logtail_dashboard') }}" target="_blank" rel="noopener noreferrer">
          <i class="fas fa-file-alt"></i> Logtail
        </a>
        <a class="btn btn-preseed" href="{{ url_for('preseed.index') }}" target="_blank" rel="noopener noreferrer">
          <i class="fa fa-wrench"></i> Preseed Configurator
        </a>
      </div>
      <div class="divider"></div>
      <div class="header-group">
        <button class="btn" id="edit-preseed"><i class="fa fa-edit"></i> Preseed</button>
        <button class="btn" id="edit-dnsmasq"><i class="fa fa-network-wired"></i> DHCP / iPXE</button>
        <button class="btn" id="edit-ipxe"><i class="fa fa-code"></i> iPXE</button>
      </div>
      <div class="divider"></div>
      <div class="header-group">
        <button class="btn btn-danger" id="clear-db"><i class="fa fa-trash"></i> Очистить</button>
        <button class="btn" id="toggle-ansible"><i class="fa fa-robot"></i> Ansible</button>
        <button class="btn" id="run-ansible" style="background:#43b581">
          <i class="fa fa-play"></i> Запустить Ansible
        </button>
      </div>
      <div class="semaphore-status" id="semaphore-status">
        <i class="fas fa-sync fa-spin"></i> Загрузка статуса...
      </div>
    </div>
  </header>
  <div id="ansible-panel" style="margin: 24px 0; padding: 16px; border-radius: 8px; background: var(--bg); border: 1px solid var(--border); display: none;">
    <h3><i class="fa fa-robot"></i> Ansible</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
      <button class="btn" id="edit-inventory"><i class="fa fa-list"></i> inventory.ini</button>
      <button class="btn" id="edit-playbook"><i class="fa fa-file-code"></i> playbook.yml</button>
      <button class="btn" id="manage-files"><i class="fa fa-folder"></i> Файлы</button>
    </div>
    <h4><i class="fa fa-terminal"></i> Журнал выполнения Ansible</h4>
    <div class="log-viewer" id="ansible-log"></div>
  </div>
  <div class="container">
    <table>
      <thead>
        <tr>
          <th>MAC</th>
          <th>IP</th>
          <th>Статус</th>
          <th>Last Seen</th>
          <th>Состояние</th>
          <th>GUI</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody id="hosts-table-body">
        {% for h in hosts %}
        <tr data-ip="{{ h.ip }}" data-mac="{{ h.mac }}">
          <td>{{ h.mac }}</td>
          <td>{{ h.ip }}</td>
          <td>{{ h.stage }}</td>
          <td><time datetime="{{ h.last }}">{{ h.last }}</time></td>
          <td class="status {{ 'online' if h.online else 'offline' }}">
            <i class="fa fa-circle"></i>
            <span>{{ 'Online' if h.online else 'Offline' }}</span>
          </td>
          <td>
            <a class="btn-portainer portainer-link" href="http://{{ h.ip }}:9000" target="_blank" rel="noopener noreferrer" title="Portainer" style="display: {% if h.ip and h.ip != '—' %}inline-flex{% else %}none{% endif %};">
              <i class="fab fa-docker"></i> Portainer
            </a>
          </td>
          <td class="actions-cell">
            <button class="btn-wol" data-mac="{{ h.mac }}" title="Включить (Wake-on-LAN)">
              <i class="fas fa-plug"></i> WOL
            </button>
            <button class="btn-shutdown" data-ip="{{ h.ip }}" title="Выключить">
              <i class="fas fa-power-off"></i> Shutdown
            </button>
            <button class="btn-reboot" data-ip="{{ h.ip }}" title="Перезагрузить">
              <i class="fa fa-sync-alt"></i> reboot
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="overlay"></div>
  <!-- Модальные окна -->
  <div class="modal" id="preseed-modal">
    <header><span>preseed.cfg</span><button class="btn close-modal" data-modal="preseed-modal"><i class="fa fa-times"></i></button></header>
    <textarea id="preseed-content"></textarea>
    <div class="controls"><button class="btn" id="save-preseed"><i class="fa fa-save"></i> Сохранить</button></div>
  </div>
  <div class="modal" id="dnsmasq-modal">
    <header><span>DNSMasq DHCP / iPXE</span><button class="btn close-modal" data-modal="dnsmasq-modal"><i class="fa fa-times"></i></button></header>
    <textarea id="dnsmasq-content"></textarea>
    <div class="controls">
      <button class="btn" id="save-dnsmasq"><i class="fa fa-save"></i> Сохранить и перезапустить</button>
      <button class="btn" id="add-dhcp-host"><i class="fa fa-plus"></i> Добавить MAC</button>
    </div>
  </div>
  <div class="modal" id="ipxe-modal">
    <header><span>/srv/tftp/boot.ipxe и autoexec.ipxe</span><button class="btn close-modal" data-modal="ipxe-modal"><i class="fa fa-times"></i></button></header>
    <textarea id="ipxe-content"></textarea>
    <div class="controls"><button class="btn" id="save-ipxe"><i class="fa fa-save"></i> Сохранить</button></div>
  </div>
  <div class="modal" id="playbook-modal">
    <header><span>playbook.yml</span><button class="btn close-modal" data-modal="playbook-modal"><i class="fa fa-times"></i></button></header>
    <div id="playbook-editor-container"><div id="playbook-editor"></div></div>
    <div class="controls"><button class="btn" id="save-playbook"><i class="fa fa-save"></i> Сохранить</button></div>
  </div>
  <div class="modal" id="inventory-modal">
    <header><span>inventory.ini</span><button class="btn close-modal" data-modal="inventory-modal"><i class="fa fa-times"></i></button></header>
    <textarea id="inventory-content"></textarea>
    <div class="controls"><button class="btn" id="save-inventory"><i class="fa fa-save"></i> Сохранить</button></div>
  </div>
  <div class="modal" id="files-modal">
    <header><span>Файлы /root/ansible/files</span><button class="btn close-modal" data-modal="files-modal"><i class="fa fa-times"></i></button></header>
    <div class="file-list-simple-container">
      <table class="file-simple-table">
        <thead>
          <tr>
            <th>Имя файла</th>
            <th>Размер</th>
            <th>Изменен</th>
          </tr>
        </thead>
        <tbody id="files-simple-list-body"></tbody>
      </table>
    </div>
  </div>
  <!-- CodeMirror -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/yaml/yaml.min.js"></script>
  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>
